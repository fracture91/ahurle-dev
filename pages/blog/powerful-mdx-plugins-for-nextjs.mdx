import * as mdxLogo from "@/public/img/mdx-logo.svg"
import imgAttrs from "@/helpers/imgAttrs"

export const meta = {
  title: "Powerful MDX Plugins for Next.js",
  published: true,
  datePublished: 1621205087000,
  bannerPhoto: {
    ...imgAttrs(mdxLogo),
    alt: "The MDX logo - a black 'M', downwards arrow, and orange 'X'",
  },
}

Here is an introduction

Despite the title of this article, these plugins are not strictly "for Next.js". I'll go over some Next-specific setup and a few plugins to help with that, but most of these will work with any framework.

# Basic, Testable MDX Setup

There are
[a ton of methods for integrating MDX with Next.js](https://www.joshwcomeau.com/blog/how-i-built-my-blog/#using-mdx-with-nextjs).
I chose
[`@next/mdx`](https://github.com/vercel/next.js/tree/canary/packages/next-mdx)
for these reasons:

- It's the "official" way, and uses the stable and popular [`@mdx-js/mdx`](https://github.com/mdx-js/mdx) v1
- It allows using the full power of MDX (`import`, `export`, etc.). next-mdx-remote disallows `import`/`export`.

Unfortunately, there are some caveats:

- `@next/mdx` may not scale as well as alternatives, but I don't plan on writing hundreds of blog articles anyway
- Because all of the MDX configuration happens in plain old Node JS files when Next boots, [none of my custom plugins can use TypeScript](https://github.com/vercel/next.js/issues/5318).  That is, unless I want to extract them out into a separate package which transpiles for me.  Luckily, [JSDoc comments](https://www.typescriptlang.org/docs/handbook/jsdoc-supported-types.html) can bridge the gap.

Following the `@next/mdx` setup instructions will let you add files in `./pages/blog/a-cool-article.mdx`, and they will be treated like [any other page](https://nextjs.org/docs/basic-features/pages):

```jsx
export const meta = {
  title: "A Cool Article",
  bannerPhoto: "/img/a-picture.jpg",
}

Hello world
```

The next problem to solve is how to wrap a blog post in some kind of shared layout.  For example, I'd like to read the title from the `meta` object above so I can put it in `<head><title>A Cool Article</title></head>`, and put the `bannerPhoto` inside an `<img>` element that's bigger than other images in my markdown.  To do this, simply provide a component as a default export:

```jsx
import { MDXBlogLayout } from "@/components/MDXBlogLayout"
export default MDXBlogLayout
```

The MDXBlogLayout component will receive [all exported data as props](https://mdxjs.com/advanced/components#layout-props).

Another feature I'd like is to post-process the `meta` object at build time so I can validate its structure, add some defaults for missing data, etc.  Well, since our MDX file is just like any other page, we can export a [getStaticProps](https://nextjs.org/docs/basic-features/data-fetching#getstaticprops-static-generation) function which is responsible for this validation.

```jsx
import { getBlogStaticProps } from "@/helpers/getBlogStaticProps"
export const getStaticProps = (...args) =>
  getBlogStaticProps(...args, layoutProps)
```

`layoutProps` is magically provided by MDX - it contains all `export`ed data, including `meta`.  We want to pass that to the shared `getBlogStaticProps` so it can work with `meta`.  Note that this [will probably break in MDX v2](https://github.com/mdx-js/mdx/pull/1199)!

At this point, you'll probably run into a compilation error regarding `getStaticProps`.  You'll need [this babel plugin](https://github.com/vercel/next.js/issues/12053#issuecomment-622939046) from Matija MarohniÄ‡ to fix it.  [Here it is in my repo](https://github.com/fracture91/ahurle-dev/blob/master/babel-plugin-nextjs-mdx-patch.js) for posterity.

The final piece of the puzzle is getting this working in tests, specifically with [`next-page-tester`](https://github.com/toomuchdesign/next-page-tester/).  What's tricky about Jest is that it's a totally separate build environment from the webpack setup provided by Next.js.  It has no idea how to handle `import article from "@/pages/blog/a-cool-article.mdx"`.  Luckily, there is some magic called [`jest-transformer-mdx`](https://github.com/bitttttten/jest-transformer-mdx) which will teach Jest how to handle those imports.

The problem with `jest-transformer-mdx` is that it does not have a way to configure MDX plugins.  I have [a PR up to solve the problem](https://github.com/bitttttten/jest-transformer-mdx/pull/20), but in the meantime you can use [this patch](https://github.com/fracture91/ahurle-dev/blob/master/patches/jest-transformer-mdx%2B2.2.0.patch).  This lets you [configure Jest like so](https://github.com/fracture91/ahurle-dev/blob/ef0fd642db4b70e958d85625a7a3652ae418811b/jest.config.js#L20-L23) to point at [a shared configuration file](https://github.com/fracture91/ahurle-dev/blob/ef0fd642db4b70e958d85625a7a3652ae418811b/config/mdxOptions.js#L54-L70), which is [also used by `@next/mdx`](https://github.com/fracture91/ahurle-dev/blob/ef0fd642db4b70e958d85625a7a3652ae418811b/next.config.js#L12-L15).  Now all of our MDX plugins will run in tests too, hooray!


# A Couple Simple Plugins

Let's walk through some MDX plugin basics to get warmed up.

Right now your shared configuration file looks something like this, since you have no plugins:

```js
module.exports = {
  remarkPlugins: [],
  rehypePlugins: [],
}
```

Plugins are separated into two categories: those that operate on an Abstract Syntax Tree representing the Markdown document (`remarkPlugins`), and those that operate on an AST representing the HTML that the Markdown turns into (`rehypePlugins`).  In both ASTs you can find some extra nodes representing MDX's `import`/`export` statements.

Both kinds of plugins are basically functions which take two arguments: the first is the AST, the second is the file.  Plugins usually mutate the tree in order to work their magic.  You can read [the official docs](https://mdxjs.com/advanced/plugins) for more info. 

To get a little more concrete, here is a very simple plugin:

```js
const u = require("unist-builder")
const path = require("path")

module.exports =
  () => // curried, often used for passing options to the plugin
  (tree, file) => {
    const pathName = path.relative(process.cwd(), file.path)
    const exportNode = u(
      "export",
      `export const path = ${JSON.stringify(pathName)}`
    )
    tree.children.unshift(exportNode)
  }
```

In this plugin, I want to add an `export` statement containing the current file path, so I can grab a URL slug for the page in `getStaticProps`, among other things.  First I calculate a relative path to the file specified in the second argument, then I create an AST node representing an `export` statement, and then insert that node into the tree.  If I add this function to my `remarkPlugins` array, it will be like I typed `export const path = "./pages/blog/a-cool-article"` at the beginning of every file.

This "add an export statement" pattern is extremely useful and present in most of my other plugins.  It lets you use the added data inside the MDX file itself, outside of it with `import { path } from "@/pages/blog/a-cool-article.mdx"`, or inside `getStaticProps` thanks to the `layoutProps` magic we added earlier.

---

Let's try to solve a different problem, this time with a `rehypePlugin`.  All of my blog articles add their own `<h1>` tag in `MDXBlogLayout`.

Let's look at a plugin that actually examines the AST - this time with `rehype`:

```js
const visit = require("unist-util-visit")
const shiftHeadings = require("hast-util-shift-heading")

module.exports =
  () =>
  (tree, _file) => {
    let hasH1 = false
    visit(tree, ["element"], (node) => {
      if (node.tagName === "h1") {
        hasH1 = true
        return visit.EXIT
      }
      return visit.CONTINUE
    })
    if (hasH1) {
      shiftHeadings(tree, 1)
    }
  }
```


- Need file path to e.g. get the blog post slug
- This pattern of adding an export node at the end is very useful
- Need to downgrade headers because I add one H1 at the top in my default layout

```jsx
export const meta = {
  title: "A Cool Blog Post",
  // ...
}
```

Can write my headings like so:

```md
# First heading

# Second heading

## Nested inside second heading
```

```md
## First heading

## Second heading

### Nested inside second heading
```

# Remove Boilerplate

- Show plugins that avoid copypasta - mdxDefaultLayout, mdxDefaultGetStaticProps

# Measure Reading Time

# Extract Article Excerpts

# Build Outlines for Table of Contents

# Find Image Dimensions for next/image

- Plugin for getting image sizes: https://kylepfromer.com/blog/nextjs-image-component-blog
- Webpack loader for importing images in MDX with size info
- Matching stub for jest
